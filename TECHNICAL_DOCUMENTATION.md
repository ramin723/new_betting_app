# مستندات فنی پروژه

## معماری کلی
این پروژه بر پایه Nuxt.js (نسخه 3) ساخته شده و از TypeScript برای توسعه استفاده می‌کند. معماری پروژه شامل بخش‌های زیر است:

### تکنولوژی‌های اصلی
- **فریم‌ورک**: Nuxt.js 3
- **زبان برنامه‌نویسی**: TypeScript
- **پایگاه داده**: SQLite (با استفاده از Sequelize ORM)
- **احراز هویت**: NextAuth.js
- **UI**: Tailwind CSS

### ساختار پوشه‌ها
```
├── app/                  # کامپوننت‌های اصلی برنامه
├── assets/              # فایل‌های استاتیک (CSS, images, etc.)
├── components/          # کامپوننت‌های قابل استفاده مجدد
├── composables/         # توابع قابل استفاده مجدد Vue
├── config/             # فایل‌های پیکربندی
├── layouts/            # قالب‌های صفحات
├── middleware/         # میان‌افزارها
├── models/             # مدل‌های پایگاه داده
├── pages/              # صفحات برنامه
├── plugins/            # پلاگین‌های Nuxt
├── public/             # فایل‌های عمومی
├── server/             # کدهای سمت سرور
├── types/              # تعاریف TypeScript
└── utils/              # توابع کمکی
```

## وابستگی‌های اصلی
- `@heroicons/vue`: برای آیکون‌ها
- `@nuxtjs/supabase`: ارتباط با Supabase
- `@sidebase/nuxt-auth`: مدیریت احراز هویت
- `chart.js`: رسم نمودار
- `sequelize`: ORM برای ارتباط با پایگاه داده
- `sqlite3`: پایگاه داده
- `ws`: برای ارتباطات WebSocket

## بررسی تفصیلی
در ادامه، هر بخش از پروژه را به صورت جداگانه و با جزئیات کامل بررسی خواهیم کرد.

### پایگاه داده
پروژه از SQLite به عنوان پایگاه داده استفاده می‌کند که از طریق Sequelize ORM مدیریت می‌شود. تنظیمات اتصال در `server/plugins/sequelize.ts` قرار دارد.

## ساختار پایگاه داده

### مدل‌های اصلی

#### 1. مدل User
- **فیلدهای اصلی**:
  - `username`: نام کاربری (یکتا)
  - `telegram_id`: شناسه تلگرام (یکتا)
  - `email`: ایمیل (یکتا)
  - `first_name`: نام
  - `last_name`: نام خانوادگی
  - `password`: رمز عبور
  - `balance`: موجودی کیف پول
  - `wallet_address`: آدرس کیف پول (یکتا)
  - `isBlocked`: وضعیت مسدودیت
  - `total_referral_earnings`: مجموع درآمد از دعوت
  - `role`: نقش کاربر (پیش‌فرض: 'user')

#### 2. مدل Event
- **فیلدهای اصلی**:
  - `title`: عنوان رویداد
  - `description`: توضیحات
  - `event_type`: نوع رویداد ('yes_no', 'winner', 'custom')
  - `question`: سوال رویداد
  - `result_time`: زمان مشخص شدن نتیجه
  - `betting_deadline`: مهلت شرط‌بندی
  - `start_time`: زمان شروع نمایش
  - `end_time`: زمان پایان نمایش
  - `reference_event`: رویداد مرجع
  - `reference_link`: لینک مرجع
  - `status`: وضعیت ('draft', 'pending', 'active', 'closed', 'cancelled')
  - `creator_id`: شناسه سازنده
  - `admin_note`: یادداشت ادمین
  - `total_pool`: مجموع پول شرط‌بندی شده
  - `commission_creator`: کمسیون سازنده (2%)
  - `commission_referral`: کمسیون دعوت (5%)
  - `is_featured`: ویژه بودن رویداد
  - `template_id`: شناسه قالب

#### 3. مدل Bet
- **فیلدهای اصلی**:
  - `user_id`: شناسه کاربر
  - `event_id`: شناسه رویداد
  - `option_id`: شناسه گزینه
  - `bet_amount`: مبلغ شرط
  - `status`: وضعیت ('active', 'won', 'lost', 'cancelled')
  - `potential_win_amount`: مبلغ احتمالی برد

- **ایندکس‌ها**:
  - user_id
  - event_id
  - option_id
  - status

#### 4. مدل Payment
- **فیلدهای اصلی**:
  - `user_id`: شناسه کاربر
  - `amount`: مبلغ
  - `method`: روش پرداخت
  - `status`: وضعیت پرداخت

#### 5. مدل WalletHistory
- **فیلدهای اصلی**:
  - `user_id`: شناسه کاربر
  - `amount`: مبلغ
  - `type`: نوع تراکنش
  - `status`: وضعیت تراکنش

### روابط بین مدل‌ها
- User -> Event (یک به چند)
- User -> Bet (یک به چند)
- Event -> Bet (یک به چند)
- User -> Payment (یک به چند)
- User -> WalletHistory (یک به چند)

### تنظیمات پایگاه داده
- استفاده از SQLite
- فعال بودن timestamps
- استفاده از underscored برای نام‌گذاری فیلدها
- فعال بودن logging برای دیباگ
- حفظ داده‌های موجود در هنگام سینک (force: false)
- عدم تغییر ساختار در هنگام سینک (alter: false)

### کمسیون‌ها
- کمسیون سازنده رویداد: 2% (0.02)
- کمسیون دعوت: 5% (0.05)

## مدل‌های پایگاه داده

### مدل User
مدل `User` مسئول نگهداری اطلاعات کاربران سیستم است.

#### فیلدها
- **id**: شناسه یکتای کاربر (INTEGER, Auto Increment, Primary Key)
- **username**: نام کاربری (STRING, Unique, Required)
- **telegram_id**: شناسه تلگرام کاربر (STRING, Unique, Optional)
- **email**: آدرس ایمیل (STRING, Unique, Optional, Validated)
- **first_name**: نام (STRING, Optional)
- **last_name**: نام خانوادگی (STRING, Optional)
- **password**: رمز عبور (STRING, Required)
- **balance**: موجودی حساب (FLOAT, Default: 0)
- **wallet_address**: آدرس کیف پول (STRING, Unique, Optional)
- **isBlocked**: وضعیت مسدودیت کاربر (BOOLEAN, Default: false)
- **total_referral_earnings**: مجموع درآمد از معرفی (FLOAT, Default: 0)
- **role**: نقش کاربر (STRING, Default: 'user')

#### ویژگی‌ها
- استفاده از Timestamps (createdAt و updatedAt)
- اعتبارسنجی ایمیل
- مدیریت نقش‌های کاربری
- سیستم معرفی کاربران (Referral)
- امکان مسدودسازی کاربر
- مدیریت کیف پول و موجودی

## پیاده‌سازی مدل‌ها

### مدل User
مدل User با TypeScript پیاده‌سازی شده و شامل ویژگی‌های زیر است:

#### ویژگی‌های اصلی
- **Type Safety**:
  - استفاده از interface‌های دقیق برای تمام فیلدها
  - تعریف دقیق نوع‌های داده
  - استفاده از `!` برای فیلدهای اجباری

- **Validation‌ها**:
  - نام کاربری: 3 تا 30 کاراکتر
  - ایمیل: فرمت معتبر
  - نام و نام خانوادگی: 2 تا 50 کاراکتر
  - رمز عبور: حداقل 8 کاراکتر
  - موجودی و درآمد: مقادیر غیر منفی

- **امنیت**:
  - هش کردن رمز عبور با bcrypt
  - تولید توکن JWT برای احراز هویت
  - اعتبارسنجی نقش‌های کاربری

- **ایندکس‌ها**:
  - username (یکتا)
  - email (یکتا)
  - telegram_id (یکتا)
  - wallet_address (یکتا)

- **Hooks**:
  - beforeCreate: هش کردن رمز عبور
  - beforeUpdate: هش کردن رمز عبور در صورت تغییر

#### Interface‌ها
1. **UserAttributes**: تعریف ویژگی‌های اصلی مدل
2. **UserModel**: تعریف متدهای اضافی مدل
3. **CreateUserInput**: داده‌های مورد نیاز برای ایجاد کاربر
4. **UpdateUserInput**: داده‌های قابل به‌روزرسانی
5. **UserResponse**: ساختار پاسخ API

### مراحل بعدی
1. **پیاده‌سازی مدل Event**:
   - تعریف interface‌ها
   - پیاده‌سازی validation‌ها
   - اضافه کردن متدهای محاسباتی
   - تعریف روابط با مدل User

2. **پیاده‌سازی مدل Bet**:
   - تعریف interface‌ها
   - پیاده‌سازی validation‌ها
   - اضافه کردن متدهای محاسباتی
   - تعریف روابط با مدل‌های User و Event

3. **پیاده‌سازی مدل‌های Payment و WalletHistory**:
   - تعریف interface‌ها
   - پیاده‌سازی validation‌ها
   - تعریف روابط با مدل User

4. **تعریف روابط بین مدل‌ها**:
   - User -> Event (یک به چند)
   - User -> Bet (یک به چند)
   - Event -> Bet (یک به چند)
   - User -> Payment (یک به چند)
   - User -> WalletHistory (یک به چند)

5. **تست و اعتبارسنجی**:
   - تست validation‌ها
   - تست روابط
   - تست محاسبات
   - تست امنیت

## پیاده‌سازی مدل Bet

مدل Bet یکی از مدل‌های اصلی سیستم است که مسئول مدیریت شرط‌های کاربران است. این مدل شامل ویژگی‌های زیر است:

### ویژگی‌های اصلی
- `id`: شناسه یکتای شرط
- `user_id`: شناسه کاربر شرط‌بند
- `event_id`: شناسه رویداد مورد شرط
- `option_id`: شناسه گزینه انتخاب شده
- `bet_amount`: مبلغ شرط
- `status`: وضعیت شرط (فعال، برنده، بازنده، لغو شده)
- `potential_win_amount`: مبلغ احتمالی برد

### متدهای اضافی
- `isWinnable`: بررسی امکان برد شرط
- `calculateWinnings`: محاسبه مبلغ احتمالی برد
- `getUser`: دریافت اطلاعات کاربر شرط‌بند
- `getEvent`: دریافت اطلاعات رویداد مورد شرط

### اعتبارسنجی‌ها
- مبلغ شرط: مقدار غیر منفی
- مبلغ احتمالی برد: مقدار غیر منفی
- شناسه‌های کاربر و رویداد: وجود در پایگاه داده

### ایندکس‌ها
- کاربر
- رویداد
- گزینه
- وضعیت

### هوک‌ها
- `beforeCreate`: محاسبه مبلغ احتمالی برد در زمان ایجاد
- `beforeUpdate`: به‌روزرسانی مبلغ احتمالی برد در صورت تغییر مبلغ یا گزینه

### نکات مهم
1. شرط‌ها به صورت پیش‌فرض در وضعیت فعال ایجاد می‌شوند
2. مبلغ احتمالی برد به صورت خودکار محاسبه و به‌روزرسانی می‌شود
3. امکان برد فقط برای شرط‌های فعال وجود دارد
4. مبالغ به صورت اعشاری با دو رقم اعشار ذخیره می‌شوند

## پیاده‌سازی مدل Event

مدل Event یکی از مدل‌های اصلی سیستم است که مسئول مدیریت رویدادهای شرط‌بندی است. این مدل شامل ویژگی‌های زیر است:

### ویژگی‌های اصلی
- `id`: شناسه یکتای رویداد
- `title`: عنوان رویداد (3 تا 100 کاراکتر)
- `description`: توضیحات رویداد (اختیاری)
- `event_type`: نوع رویداد (بله/خیر، برنده، سفارشی)
- `question`: سوال اصلی رویداد (3 تا 200 کاراکتر)
- `result_time`: زمان اعلام نتیجه
- `betting_deadline`: مهلت شرط‌بندی
- `start_time`: زمان شروع رویداد (اختیاری)
- `end_time`: زمان پایان رویداد (اختیاری)
- `reference_event`: رویداد مرجع (اختیاری)
- `reference_link`: لینک مرجع (اختیاری)
- `status`: وضعیت رویداد (پیش‌نویس، در انتظار، فعال، بسته شده، لغو شده)
- `creator_id`: شناسه سازنده رویداد
- `admin_note`: یادداشت ادمین (اختیاری)
- `total_pool`: مجموع مبالغ شرط‌بندی شده
- `commission_creator`: درصد کمیسیون سازنده (پیش‌فرض: 2%)
- `commission_referral`: درصد کمیسیون معرف (پیش‌فرض: 5%)
- `is_featured`: آیا رویداد ویژه است
- `template_id`: شناسه قالب (اختیاری)

### متدهای اضافی
- `calculatePotentialWinnings`: محاسبه مقدار احتمالی برد
- `isActive`: بررسی فعال بودن رویداد
- `canAcceptBets`: بررسی امکان پذیرش شرط جدید
- `updateTotalPool`: به‌روزرسانی مجموع مبالغ شرط‌بندی شده

### روابط
- `getBets`: دریافت تمام شرط‌های رویداد
- `getOptionBets`: دریافت شرط‌های یک گزینه خاص

### اعتبارسنجی‌ها
- عنوان: 3 تا 100 کاراکتر
- سوال: 3 تا 200 کاراکتر
- لینک مرجع: فرمت URL معتبر
- مبالغ: مقادیر غیر منفی
- درصدهای کمیسیون: بین 0 تا 100

### ایندکس‌ها
- عنوان (یکتا)
- سازنده
- وضعیت
- نوع رویداد
- زمان نتیجه
- مهلت شرط‌بندی

### هوک‌ها
- `beforeCreate`: تنظیم مقادیر پیش‌فرض کمیسیون‌ها

### نکات مهم
1. رویدادها به صورت پیش‌فرض در وضعیت پیش‌نویس ایجاد می‌شوند
2. کمیسیون‌ها به صورت درصدی و با دو رقم اعشار ذخیره می‌شوند
3. مجموع مبالغ شرط‌بندی شده به صورت خودکار به‌روزرسانی می‌شود
4. امکان شرط‌بندی فقط در زمان فعال بودن و قبل از مهلت تعیین شده وجود دارد

## پیکربندی Nuxt
فایل `nuxt.config.ts` تنظیمات اصلی پروژه را مشخص می‌کند:

### تنظیمات اصلی
- **SSR**: فعال (رندرینگ سمت سرور)
- **Nitro**: پیکربندی شده برای اجرا روی Node.js
- **TypeScript**: حالت سخت‌گیرانه فعال با بررسی نوع

### ماژول‌های فعال
- `@nuxtjs/tailwindcss`: برای استایل‌دهی
- `@nuxtjs/supabase`: برای ارتباط با Supabase
- `@sidebase/nuxt-auth`: برای مدیریت احراز هویت

### تنظیمات Runtime
- **Cookie Secret**: برای رمزنگاری کوکی‌ها
- **Auth Secret**: کلید رمزنگاری JWT
- **API Base**: آدرس پایه API

### تنظیمات Supabase
- امکان ریدایرکت به مسیرهای:
  - `/login`: صفحه ورود
  - `/confirm`: صفحه تایید
  - مستثنی شده: `/register`, `/reset-password`

### تنظیمات احراز هویت
- **Origin**: آدرس اصلی سرور
- **Middleware**: فعال در سطح کل برنامه
- **Session**: 
  - به‌روزرسانی دوره‌ای: غیرفعال
  - به‌روزرسانی با فوکوس پنجره: فعال

## مسیرها و صفحات

### ساختار مسیرها
- `/`: صفحه اصلی
  - نمایش رویدادها
  - مدیریت کیف پول
  - سیستم اعلان‌ها
  - نمایش امتیازات
- `/login`: صفحه ورود
- `/create-admin`: صفحه ایجاد مدیر
- `/unauthorized`: صفحه دسترسی غیرمجاز
- `/admin/`: پنل مدیریت
- `/profile/`: صفحات مربوط به پروفایل کاربر
- `/events/`: لیست رویدادها
- `/event/`: صفحات مربوط به رویداد خاص

### صفحه اصلی (index.vue)
صفحه اصلی شامل بخش‌های زیر است:

#### هدر
- دکمه اعلان‌ها با نمایش تعداد اعلان‌های جدید
- بخش پروفایل با آواتار و نمایش امتیازات
- دکمه اتصال کیف پول

#### محتوا
- تب‌بندی دسته‌بندی‌ها
- نمایش لیست رویدادها
- حالت‌های مختلف نمایش:
  - در حال بارگذاری
  - خطا در دریافت اطلاعات
  - نمایش رویدادها

## مشکلات شناسایی شده

### 1. تداخل در تنظیمات پایگاه داده
در پروژه دو فایل مختلف برای تنظیمات پایگاه داده وجود دارد:
1. `server/plugins/sequelize.ts`: تنظیمات جدید با TypeScript
2. `server/models/database.js`: تنظیمات قدیمی با JavaScript

این تداخل می‌تواند باعث مشکلات زیر شود:
- تعریف دوگانه مدل‌ها
- تداخل در اتصال به پایگاه داده
- ناهماهنگی در تعریف فیلدها و روابط
- مشکلات در مهاجرت و به‌روزرسانی مدل‌ها

#### راه حل پیشنهادی
1. یکپارچه‌سازی تنظیمات پایگاه داده:
   - انتقال تمام مدل‌ها به فایل‌های TypeScript
   - حذف فایل `database.js` و استفاده از `sequelize.ts`
   - به‌روزرسانی تمام import‌ها در پروژه

2. بازنویسی مدل‌ها با TypeScript:
   - تعریف interface‌های مناسب
   - استفاده از type safety
   - اضافه کردن validation‌های مناسب

3. ایجاد سیستم مهاجرت:
   - استفاده از Sequelize migrations
   - نگهداری تاریخچه تغییرات
   - امکان rollback در صورت نیاز

## برنامه مهاجرت پایگاه داده

### مرحله 1: آماده‌سازی ساختار جدید
1. ایجاد پوشه‌های جدید:
   ```
   server/
   ├── models/
   │   ├── types/           # تعاریف TypeScript
   │   ├── User.ts          # مدل کاربر
   │   ├── Event.ts         # مدل رویداد
   │   ├── Bet.ts           # مدل شرط
   │   └── index.ts         # export مدل‌ها
   └── plugins/
       └── sequelize.ts     # تنظیمات Sequelize
   ```

2. تعریف interface‌ها در `types/`:
   - `UserInterface.ts`
   - `EventInterface.ts`
   - `BetInterface.ts`
   - و غیره...

3. انتقال تنظیمات Sequelize:
   - به‌روزرسانی `sequelize.ts`
   - اضافه کردن type safety
   - تنظیم logging و validation

### مرحله 2: مهاجرت مدل‌ها
1. تبدیل مدل User:
   - انتقال به TypeScript
   - اضافه کردن validation‌ها
   - تعریف روابط

2. تبدیل مدل Event:
   - انتقال به TypeScript
   - اضافه کردن validation‌ها
   - تعریف روابط

3. تبدیل سایر مدل‌ها:
   - Bet
   - Payment
   - WalletHistory
   - و غیره...

### مرحله 3: به‌روزرسانی API‌ها
1. به‌روزرسانی import‌ها:
   - تغییر مسیرهای import
   - اضافه کردن type checking
   - اصلاح validation‌ها

2. تست API‌ها:
   - تست endpoint‌ها
   - بررسی validation‌ها
   - تست روابط

### مرحله 4: پاکسازی و بهینه‌سازی
1. حذف فایل‌های قدیمی:
   - `database.js`
   - فایل‌های JavaScript اضافی

2. بهینه‌سازی کد:
   - حذف کد تکراری
   - بهبود ساختار
   - اضافه کردن کامنت‌ها

### مرحله 5: تست و مستندسازی
1. تست نهایی:
   - تست عملکرد
   - تست امنیت
   - تست کارایی

2. به‌روزرسانی مستندات:
   - مستندات API
   - مستندات مدل‌ها
   - راهنمای توسعه

### مقادیر ثابت سیستم
تمام مقادیر ثابت سیستم در فایل `server/constants/constants.ts` تعریف شده‌اند:

#### کمسیون‌ها
- کمسیون سازنده رویداد: 2% (0.02)
- کمسیون دعوت: 5% (0.05)

#### وضعیت‌ها
- **رویداد**: draft, pending, active, closed, cancelled
- **شرط**: active, won, lost, cancelled
- **نقش‌های کاربری**: user, admin, moderator

#### محدودیت‌ها
- **کیف پول**:
  - حداقل مبلغ شرط: 0.1
  - حداکثر مبلغ شرط: 1000
  - حداقل برداشت: 10
  - حداکثر برداشت: 10000

- **رویداد**:
  - حداقل زمان شرط‌بندی: 5 دقیقه
  - حداکثر زمان شرط‌بندی: 7 روز
  - حداقل تعداد گزینه‌ها: 2
  - حداکثر تعداد گزینه‌ها: 10

#### تنظیمات امنیتی
- حداقل طول رمز عبور: 8 کاراکتر
- مدت اعتبار توکن: 24 ساعت
- مدت اعتبار توکن تازه‌سازی: 7 روز

#### تنظیمات API
- نسخه API: v1
- محدودیت درخواست: 100 درخواست در هر 15 دقیقه
- صفحه‌بندی پیش‌فرض: 10 آیتم
- حداکثر آیتم در صفحه: 50

[ادامه مستندات در حال تکمیل...] 