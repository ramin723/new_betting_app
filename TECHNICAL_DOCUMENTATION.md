# مستندات فنی پروژه

## معماری کلی
این پروژه بر پایه Nuxt.js (نسخه 3) ساخته شده و از TypeScript برای توسعه استفاده می‌کند. معماری پروژه شامل بخش‌های زیر است:

### تکنولوژی‌های اصلی
- **فریم‌ورک**: Nuxt.js 3
- **زبان برنامه‌نویسی**: TypeScript
- **پایگاه داده**: SQLite (با استفاده از Sequelize ORM)
- **احراز هویت**: NextAuth.js
- **UI**: Tailwind CSS

### ساختار پوشه‌ها
```
├── app/                  # کامپوننت‌های اصلی برنامه
├── assets/              # فایل‌های استاتیک (CSS, images, etc.)
├── components/          # کامپوننت‌های قابل استفاده مجدد
├── composables/         # توابع قابل استفاده مجدد Vue
├── config/             # فایل‌های پیکربندی
├── layouts/            # قالب‌های صفحات
├── middleware/         # میان‌افزارها
├── models/             # مدل‌های پایگاه داده
├── pages/              # صفحات برنامه
├── plugins/            # پلاگین‌های Nuxt
├── public/             # فایل‌های عمومی
├── server/             # کدهای سمت سرور
├── types/              # تعاریف TypeScript
└── utils/              # توابع کمکی
```

## وابستگی‌های اصلی
- `@heroicons/vue`: برای آیکون‌ها
- `@nuxtjs/supabase`: ارتباط با Supabase
- `@sidebase/nuxt-auth`: مدیریت احراز هویت
- `chart.js`: رسم نمودار
- `sequelize`: ORM برای ارتباط با پایگاه داده
- `sqlite3`: پایگاه داده
- `ws`: برای ارتباطات WebSocket

## بررسی تفصیلی
در ادامه، هر بخش از پروژه را به صورت جداگانه و با جزئیات کامل بررسی خواهیم کرد.

### پایگاه داده
پروژه از SQLite به عنوان پایگاه داده استفاده می‌کند که از طریق Sequelize ORM مدیریت می‌شود. تنظیمات اتصال در `server/plugins/sequelize.ts` قرار دارد.

## مدل‌های پایگاه داده

### مدل User
مدل `User` مسئول نگهداری اطلاعات کاربران سیستم است.

#### فیلدها
- **id**: شناسه یکتای کاربر (INTEGER, Auto Increment, Primary Key)
- **username**: نام کاربری (STRING, Unique, Required)
- **telegram_id**: شناسه تلگرام کاربر (STRING, Unique, Optional)
- **email**: آدرس ایمیل (STRING, Unique, Optional, Validated)
- **first_name**: نام (STRING, Optional)
- **last_name**: نام خانوادگی (STRING, Optional)
- **password**: رمز عبور (STRING, Required)
- **balance**: موجودی حساب (FLOAT, Default: 0)
- **wallet_address**: آدرس کیف پول (STRING, Unique, Optional)
- **isBlocked**: وضعیت مسدودیت کاربر (BOOLEAN, Default: false)
- **total_referral_earnings**: مجموع درآمد از معرفی (FLOAT, Default: 0)
- **role**: نقش کاربر (STRING, Default: 'user')

#### ویژگی‌ها
- استفاده از Timestamps (createdAt و updatedAt)
- اعتبارسنجی ایمیل
- مدیریت نقش‌های کاربری
- سیستم معرفی کاربران (Referral)
- امکان مسدودسازی کاربر
- مدیریت کیف پول و موجودی

## پیکربندی Nuxt
فایل `nuxt.config.ts` تنظیمات اصلی پروژه را مشخص می‌کند:

### تنظیمات اصلی
- **SSR**: فعال (رندرینگ سمت سرور)
- **Nitro**: پیکربندی شده برای اجرا روی Node.js
- **TypeScript**: حالت سخت‌گیرانه فعال با بررسی نوع

### ماژول‌های فعال
- `@nuxtjs/tailwindcss`: برای استایل‌دهی
- `@nuxtjs/supabase`: برای ارتباط با Supabase
- `@sidebase/nuxt-auth`: برای مدیریت احراز هویت

### تنظیمات Runtime
- **Cookie Secret**: برای رمزنگاری کوکی‌ها
- **Auth Secret**: کلید رمزنگاری JWT
- **API Base**: آدرس پایه API

### تنظیمات Supabase
- امکان ریدایرکت به مسیرهای:
  - `/login`: صفحه ورود
  - `/confirm`: صفحه تایید
  - مستثنی شده: `/register`, `/reset-password`

### تنظیمات احراز هویت
- **Origin**: آدرس اصلی سرور
- **Middleware**: فعال در سطح کل برنامه
- **Session**: 
  - به‌روزرسانی دوره‌ای: غیرفعال
  - به‌روزرسانی با فوکوس پنجره: فعال

## مسیرها و صفحات

### ساختار مسیرها
- `/`: صفحه اصلی
  - نمایش رویدادها
  - مدیریت کیف پول
  - سیستم اعلان‌ها
  - نمایش امتیازات
- `/login`: صفحه ورود
- `/create-admin`: صفحه ایجاد مدیر
- `/unauthorized`: صفحه دسترسی غیرمجاز
- `/admin/`: پنل مدیریت
- `/profile/`: صفحات مربوط به پروفایل کاربر
- `/events/`: لیست رویدادها
- `/event/`: صفحات مربوط به رویداد خاص

### صفحه اصلی (index.vue)
صفحه اصلی شامل بخش‌های زیر است:

#### هدر
- دکمه اعلان‌ها با نمایش تعداد اعلان‌های جدید
- بخش پروفایل با آواتار و نمایش امتیازات
- دکمه اتصال کیف پول

#### محتوا
- تب‌بندی دسته‌بندی‌ها
- نمایش لیست رویدادها
- حالت‌های مختلف نمایش:
  - در حال بارگذاری
  - خطا در دریافت اطلاعات
  - نمایش رویدادها

## مشکلات شناسایی شده

### 1. تداخل در تنظیمات پایگاه داده
در پروژه دو فایل مختلف برای تنظیمات پایگاه داده وجود دارد:
1. `server/plugins/sequelize.ts`: تنظیمات جدید با TypeScript
2. `server/models/database.js`: تنظیمات قدیمی با JavaScript

این تداخل می‌تواند باعث مشکلات زیر شود:
- تعریف دوگانه مدل‌ها
- تداخل در اتصال به پایگاه داده
- ناهماهنگی در تعریف فیلدها و روابط
- مشکلات در مهاجرت و به‌روزرسانی مدل‌ها

#### راه حل پیشنهادی
1. یکپارچه‌سازی تنظیمات پایگاه داده:
   - انتقال تمام مدل‌ها به فایل‌های TypeScript
   - حذف فایل `database.js` و استفاده از `sequelize.ts`
   - به‌روزرسانی تمام import‌ها در پروژه

2. بازنویسی مدل‌ها با TypeScript:
   - تعریف interface‌های مناسب
   - استفاده از type safety
   - اضافه کردن validation‌های مناسب

3. ایجاد سیستم مهاجرت:
   - استفاده از Sequelize migrations
   - نگهداری تاریخچه تغییرات
   - امکان rollback در صورت نیاز

[ادامه مستندات در حال تکمیل...] 